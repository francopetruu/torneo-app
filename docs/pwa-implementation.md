# Progressive Web App (PWA) Implementation

This document describes the PWA features implemented for both the client and admin applications.

## Features Implemented

### 1. Service Worker Configuration

Both apps use `vite-plugin-pwa` to generate and register service workers automatically.

**Configuration:**

- **Register Type**: `autoUpdate` - Service worker updates automatically
- **Caching Strategy**:
  - Network-first for API calls (Supabase)
  - Cache-first for static assets (images, logos)
- **Offline Fallback**: Custom offline.html page

### 2. Manifest Files

Manifest files are automatically generated by vite-plugin-pwa with the following settings:

**Client App:**

- Name: "Beach Football Tournament"
- Short Name: "Torneo"
- Theme Color: `#0ea5e9` (Sky blue)
- Display Mode: `standalone`
- Icons: 192x192 and 512x512 PNG

**Admin App:**

- Name: "Tournament Admin Panel"
- Short Name: "Tournament Admin"
- Theme Color: `#1e40af` (Blue)
- Display Mode: `standalone`
- Icons: 192x192 and 512x512 PNG

### 3. Offline Support

#### Offline Detection

- `useOnlineStatus` hook detects network connectivity
- `OfflineIndicator` component shows a banner when offline
- Automatically updates when connection is restored

#### Offline Data Caching

- Standings data is cached in localStorage
- Cache expires after 24 hours
- Automatically falls back to cached data when offline
- Cache utilities in `lib/offline-cache.ts`

#### Offline Fallback Page

- Custom `offline.html` page shown when navigating offline
- Styled with app theme colors
- "Try Again" button to reload

### 4. Install Prompts

#### PWA Install Hook

- `usePWAInstall` hook manages install prompt state
- Detects if app is already installed
- Handles `beforeinstallprompt` event
- Tracks install events

#### Install Prompt Component

- `InstallPrompt` component shows install banner
- Only appears when:
  - App is installable
  - Not already installed
  - User hasn't dismissed it
- Dismiss state persisted in localStorage

## File Structure

```
apps/
├── client/
│   ├── public/
│   │   ├── offline.html          # Offline fallback page
│   │   └── README-icons.md       # Icon requirements
│   ├── src/
│   │   ├── hooks/
│   │   │   ├── useOnlineStatus.ts    # Network detection
│   │   │   └── usePWAInstall.ts       # Install prompt logic
│   │   ├── components/
│   │   │   └── layout/
│   │   │       ├── offline-indicator.tsx
│   │   │       └── install-prompt.tsx
│   │   └── lib/
│   │       └── offline-cache.ts        # Cache utilities
│   └── vite.config.ts            # PWA configuration
└── admin/
    └── [same structure as client]
```

## Usage

### Offline Indicator

The offline indicator is automatically included in the layout:

```tsx
import OfflineIndicator from "@/components/layout/offline-indicator";

// Already included in Layout component
```

### Install Prompt

The install prompt is automatically included in the layout:

```tsx
import InstallPrompt from "@/components/layout/install-prompt";

// Already included in Layout component
```

### Using Offline Cache

```tsx
import { setCache, getCache, CACHE_KEYS } from "@/lib/offline-cache";

// Store data
setCache(CACHE_KEYS.STANDINGS, standingsData, 60 * 60 * 24); // 24 hours

// Retrieve data
const cachedData = getCache<Standing[]>(CACHE_KEYS.STANDINGS);
```

### Using Online Status Hook

```tsx
import { useOnlineStatus } from "@/hooks/useOnlineStatus";

function MyComponent() {
  const isOnline = useOnlineStatus();

  if (!isOnline) {
    return <div>You're offline</div>;
  }

  return <div>Online content</div>;
}
```

## Testing

### Testing Offline Functionality

1. **Chrome DevTools**:
   - Open DevTools → Network tab
   - Select "Offline" from throttling dropdown
   - Navigate the app and verify offline behavior

2. **Service Worker Testing**:
   - Open DevTools → Application tab → Service Workers
   - Check service worker registration
   - Test update and activation

3. **Cache Testing**:
   - Application tab → Cache Storage
   - Verify cached resources
   - Test cache invalidation

### Testing Install Process

1. **Desktop (Chrome/Edge)**:
   - Visit the app
   - Look for install icon in address bar
   - Click install and verify standalone mode

2. **Mobile (Android)**:
   - Visit the app in Chrome
   - Tap menu → "Add to Home Screen"
   - Verify app icon and standalone mode

3. **Mobile (iOS)**:
   - Visit the app in Safari
   - Tap Share → "Add to Home Screen"
   - Verify app icon and standalone mode

### Testing Install Events

1. Open browser console
2. Install the app
3. Verify `appinstalled` event fires
4. Check that install prompt disappears

## Icon Requirements

Both apps require PWA icons. See `public/README-icons.md` in each app for details.

**Required Icons:**

- `pwa-192x192.png` - 192x192 pixels
- `pwa-512x512.png` - 512x512 pixels
- `favicon.ico` - Standard favicon
- `apple-touch-icon.png` - 180x180 pixels (iOS)
- `mask-icon.svg` - SVG icon (Safari)

**Note**: Icons are not included in the repository. You need to create or generate them.

## Build and Deployment

### Development

PWA features are **disabled in development** to avoid conflicts:

```ts
devOptions: {
  enabled: false,
}
```

### Production Build

1. Build the apps:

   ```bash
   npm run build
   ```

2. Service worker is automatically generated during build

3. Verify service worker registration:
   - Check `dist/sw.js` exists
   - Check `dist/manifest.webmanifest` exists

### Deployment

1. Deploy to hosting (Vercel, Netlify, etc.)
2. Ensure HTTPS is enabled (required for PWA)
3. Verify service worker registration in browser DevTools

## Browser Support

- ✅ Chrome/Edge (Desktop & Mobile)
- ✅ Firefox (Desktop & Mobile)
- ✅ Safari (iOS 11.3+, macOS)
- ⚠️ Safari (iOS) - Limited PWA support
- ❌ Internet Explorer - Not supported

## Troubleshooting

### Service Worker Not Registering

1. Check HTTPS is enabled
2. Verify `vite-plugin-pwa` is installed
3. Check browser console for errors
4. Clear browser cache and reload

### Install Prompt Not Showing

1. Verify app meets PWA criteria:
   - HTTPS enabled
   - Valid manifest
   - Service worker registered
   - Icons provided

2. Check if app is already installed
3. Clear browser cache
4. Try incognito mode

### Offline Page Not Showing

1. Verify `offline.html` exists in `public/`
2. Check `navigateFallback` in vite.config.ts
3. Verify service worker is active
4. Test in production build (not dev mode)

## Future Enhancements

- [ ] Background sync for admin changes
- [ ] Push notifications
- [ ] Share API integration
- [ ] Periodic background sync
- [ ] Advanced caching strategies
- [ ] Offline queue for form submissions
